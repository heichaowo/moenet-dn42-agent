# DN42 BGP Peer Configuration
# Peer: AS{{ peer.asn }} ({{ peer.name }})
{% set asn = peer.asn %}
{% set com = peer.community | default({}) %}

protocol bgp dn42_{{ peer.asn }} from dn42_peer {
{% if peer.contact %}
    description "{{ peer.contact }}";
{% endif %}
    neighbor {{ peer.bgp.peer_ipv6 or peer.bgp.peer_ipv4 }} as {{ peer.asn }};
{% if peer.bgp.peer_ipv6 and (peer.bgp.peer_ipv6|lower)[:6] == 'fe80::' %}
    interface "dn42-{{ peer.asn }}";
{% endif %}
{% if peer.bgp.local_ipv6 %}
    source address {{ peer.bgp.local_ipv6.split('/')[0] if '/' in peer.bgp.local_ipv6 else peer.bgp.local_ipv6 }};
{% endif %}
{% if peer.bgp.mpbgp %}
{# ============ MP-BGP Mode ============ #}
{% if peer.bgp.peer_ipv4 and peer.bgp.peer_ipv6 %}
{# Dual-stack MP-BGP: both address families in one session #}
    ipv4 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
{% if peer.bgp.extended_nexthop %}
        extended next hop on; 
{% endif %}
    };
    ipv6 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}
{% elif peer.bgp.peer_ipv4 %}
{# IPv4-only MP-BGP #}
    ipv4 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}
{% else %}
{# IPv6-only MP-BGP #}
    ipv6 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}
{% endif %}
{% else %}
{# ============ Non-MP-BGP Mode ============ #}
{% if peer.bgp.peer_ipv4 and peer.bgp.peer_ipv6 %}
{# Dual stack without MP-BGP: need separate protocols #}
    ipv6 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}

# Second BGP protocol for IPv4 (same WG interface, different neighbor)
protocol bgp dn42_{{ peer.asn }}_v4 from dn42_peer {
{% if peer.contact %}
    description "{{ peer.contact }} (IPv4)";
{% endif %}
    neighbor {{ peer.bgp.peer_ipv4 }} as {{ peer.asn }};
{% if peer.bgp.local_ipv4 %}
    source address {{ peer.bgp.local_ipv4.split('/')[0] if '/' in peer.bgp.local_ipv4 else peer.bgp.local_ipv4 }};
{% endif %}
    ipv4 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}
{% elif peer.bgp.peer_ipv4 %}
{# IPv4-only non-MP-BGP #}
    ipv4 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}
{% else %}
{# IPv6-only non-MP-BGP #}
    ipv6 { 
        import filter dn42_import_filter; 
        export filter dn42_export_filter; 
    };
}
{% endif %}
{% endif %}
